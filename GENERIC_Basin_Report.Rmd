---
params:
 owrd_basin: "BASIN NAME"
 report_title: "TITLE"
 report_subtitle: "SUBTITLE"
 a.letter:
 html_output: FALSE
title: "`r params$report_title`"
subtitle: "`r params$report_subtitle`"
output:
  word_document:
    reference_docx: C:/Basin_Reports_2018/word_basin_report_template_style.docx
    toc: FALSE
    fig_caption: true
  html_document:
    # css: Y:\NPS_Annual_Reports\2018\Basin_Reports_2018\html_basin_report_template_style.css
    fig_caption: true
    mode: selfcontained
    number_sections: true
    toc: true
    toc_depth: 4
    toc_float: true
  pdf_document:
    fig_caption: true
always_allow_html: true
---


```{r global-setup, include=FALSE}

library(knitr)
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning=FALSE,
                      error = TRUE,
                      cache = FALSE,
                      cache.comments = FALSE,
                      include = TRUE,
                      autodep = TRUE,
                      fig.height = 6,
                      eval = TRUE
                      )

library(rgdal)
library(captioner)
library(readxl)
library(dplyr)
library(tidyr)
library(scales)
library(stringr)

# Requires use of 32 bit R and 32 bit compatible RStudio Desktop (version 1.1.463)
library(DBI)
library(odbc)

setwd("C:/Basin_Reports_2018/")

source("functions/funHelpers.R")
wqst.dir <- "//deqhq1/WQNPS/NPS_Annual_Reports/2017/R_NPS_WQStatusAndTrend/R_Outputs/WQSandT_tables/"
owri.db <- "//deqhq1/WQNPS/NPS_Annual_Reports/2018/OWRI_1995_2017/OwriDbExport_122618.mdb"
lu_dir <- "lookup_tables"

owrd_basin <- params$owrd_basin

#set.seed(42)
set.seed(99) # Willamette

# project completion year
my.year <- 2017

options(stringsAsFactors = FALSE)

# Import subbasin and Basin Report area names
owrd_huc8_shp <- readOGR(dsn=lu_dir,layer="WBD_HU08_OR", integer64="warn.loss", verbose=FALSE)

# get the huc8 shp and subbasin names so it can used in other code chunks
huc8.df <- owrd_huc8_shp@data[owrd_huc8_shp@data$BasReport==owrd_basin,]

huc8.name <- unique(huc8.df$HU_8_NAME)

# initialize picture df
pix.df <- data.frame(picture=character(0),picture_caption=character(0),picture_file=character(0))
pix.seed.df <- data.frame(picture_caption=c(NA),picture_file=c(NA))

tbls <- captioner(prefix=paste0("Table ",params$a.letter,"-"), auto_space = FALSE)
figs <- captioner(prefix=paste0("Figure ",params$a.letter,"-"), auto_space = FALSE)

```

```{r basemap-html, eval=FALSE}

library(leaflet)

GetURL <- function(service, host = "basemap.nationalmap.gov") {
  sprintf("https://%s/arcgis/services/%s/MapServer/WmsServer", host, service)
}

# The input file geodatabase
gis_dir <- "GIS"

owrd_basins_shp <- readOGR(dsn=gis_dir,layer="owrd_admin_basins", integer64="warn.loss", verbose=FALSE) 
owrd_basins_shp <- owrd_basins_shp[owrd_basins_shp$BASIN_NAME == owrd_basin,]

#owrd_basins_shp <- readOGR(dsn=gis_dir,layer="WBD_HU08_OR", integer64="warn.loss", verbose=FALSE) 
#owrd_basins_shp <- owrd_basins_shp[owrd_basins_shp$BasReport == owrd_basin,]

owrd_basins_shp_dd <-spTransform(owrd_basins_shp, CRS("+proj=longlat +datum=NAD83"))

# bounding box
bb <- as.vector(bbox(owrd_basins_shp_dd))

JS.center.map <- paste0("function(btn, map){map.fitBounds([[lat1=",bb[4],",lng1=",bb[1],"],[lat2=",bb[2],",lng2=",bb[3],"]]); }")

usgs.att <- paste0("<a href='https://www.usgs.gov/'>",
              "U.S. Geological Survey</a> | ",
              "<a href='https://www.usgs.gov/laws/policies_notices.html'>",
              "Policies</a>")

basemap <- leaflet(width = "100%") %>%
  addPolygons(data=owrd_basins_shp_dd,
              #label=~HU_8_NAME, # for when using HUC8
              label=~BASIN_NAME,
              labelOptions= labelOptions(direction = 'auto'),
              stroke = TRUE, color = "black",  fillOpacity = 0,
              group="Basin") %>%
  addTiles() %>%
  addProviderTiles(provider = "OpenStreetMap.Mapnik",
                   group="OpenStreetMap") %>%
  addWMSTiles(GetURL("USGSTopo"),
              group = "USGS Topo",
              attribution = usgs.att,
              layers = "0") %>%
  addWMSTiles(GetURL("USGSImageryOnly"),
              group = "Aerial Imagery", 
              attribution = usgs.att, 
              layers = "0") %>%
  addWMSTiles(GetURL("USGSHydroCached"), 
              group = "Hydrography", 
              options = WMSTileOptions(format = "image/png", 
                                       transparent = TRUE),
              layers = "0") %>%
  hideGroup("Hydrography")  %>%
  addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to Basin",
    onClick=JS(JS.center.map)))  %>%
  addLayersControl(baseGroups = c('OpenStreetMap','USGS Topo','Aerial Imagery'),
                   overlayGroups = c("Hydrography"))

basemap

```

```{r basin-description}

basin.df <- read_excel(path=paste0(lu_dir,"/Info_Integrated.xlsx"), sheet="Basin_Description")
basin.df <- basin.df[basin.df$owrd_basin %in% owrd_basin,]

```


# Basin Description

`r basin.df$description`


```{r landuse-table}

# Can't get these fucntions to work.
#source("functions/funHelpers.R")

nlcd_huc8_df <- read.csv(paste0(lu_dir,"/NLCD_2011_LU_sqm_by_HUC8.txt"), quote="", stringsAsFactors=FALSE)

#landuse.df <- get.landuse(nlcd_huc8_df=nlcd_huc8_df, geo_unit=owrd_basin, geo_unit_col="BasReport", group_col="BasReport")
#landuse.huc8.df <- get.landuse(nlcd_huc8_df=nlcd_huc8_df, geo_unit=owrd_basin, geo_unit_col="BasReport", group_col="HUC_8_NAME")

#Reclass the NLCD
landuse.huc8.df <- nlcd_huc8_df %>% 
  filter(BasReport %in% owrd_basin) %>% 
  group_by(HUC_8_NAME) %>% 
  dplyr::summarise(WsAreaSqKm = round(sum(VALUE_11,VALUE_12,
                                          VALUE_21,VALUE_22,VALUE_23,VALUE_24,
                                          VALUE_31,VALUE_41,VALUE_42,VALUE_43,
                                          VALUE_52,VALUE_71,VALUE_81,VALUE_82,
                                          VALUE_90,VALUE_95) * 0.001),
                   PerUrbanWs = round(sum(VALUE_21,
                                          VALUE_22,
                                          VALUE_23,
                                          VALUE_24) * 0.001 / WsAreaSqKm * 100, 1),
                   PerForestWs = round(sum(VALUE_41,
                                           VALUE_42,
                                           VALUE_43,
                                           VALUE_90) * 0.001 / WsAreaSqKm * 100, 1),
                   PerAgWs = round(sum(VALUE_81,
                                       VALUE_82) * 0.001 / WsAreaSqKm * 100, 1),
                   PerRangeWs = round(sum(VALUE_52,
                                          VALUE_71) * 0.001 / WsAreaSqKm * 100, 1),
                   PerOtherWs = round(sum(VALUE_11,
                                          VALUE_12,
                                          VALUE_31,
                                          VALUE_95) * 0.001 / WsAreaSqKm * 100, 1))

colnames(landuse.huc8.df) <- c("Subbasin", "Watershed Area (km2)", "% Urban/Roads", "% Forest", "% Cultivated"," % Range/Forest Disturbance", " %Other")

knitr::kable(landuse.huc8.df, format = "pandoc", padding = 2, digits = 1, caption = tbls(name="tbl.landuse_table", caption=paste0("2011 Land use and land cover for each subbasin in the ",owrd_basin,".")))

```


```{r lancover-map,eval.after="fig.cap", fig.cap=landmap.cap}
landmap.cap<-figs(name="figs.landcover_map",caption=paste0("Land use in the ",owrd_basin," administrative basin."))

knitr::include_graphics(path = gsub(" ", "", paste0("pictures/Landcover_",owrd_basin,".png"), fixed = TRUE))


```


## Basin Contacts
```{r basin-contact}

bc.df <- read_excel(path=paste0(lu_dir,"/Info_Integrated.xlsx"), sheet="1_bc_info")
bc.df$bc.info <- as.character(paste(bc.df$name, bc.df$phone, bc.df$email, sep = ': '))

bc.df <- bc.df[bc.df$owrd_basin %in% owrd_basin,c("admin_area", "bc.info")]

colnames(bc.df) <- c('Administrative Area', 'DEQ Basin Coordinator')

knitr::kable(bc.df, format = "pandoc", padding = 2, digits = 1, caption = tbls(name = "tbl.basin_contact", caption="Oregon DEQ basin contact."))

```


# Water Quality Impairments and TMDLs

## Water Quality Impaired Stream Segments

Under section 303(d) of the Clean Water Act, states, territories and authorized tribes must submit lists of impaired waters. Impaired waters are those that do not attain water quality standards or support all designated uses. The law requires that states establish priority rankings for waters on the lists and develop Total Maximum Daily Loads (TMDLs) for these waters. `r tbls(name='tbl.wql', display='cite')` identifies the number of `r owrd_basin` Basin waterbody segments impaired by parameter from the 2012 Integrated Report and the number of segments with approved TMDLs. Sources: [ODEQ](http://www.oregon.gov/deq/wq/Pages/WQ-Assessment.aspx), [USEPA](https://www.epa.gov/tmdl/program-overview-303d-listing-impaired-waters)


```{r wq-limited}

# Read the wq limited feature classes
# wqlim_streams_shp <- readOGR(dsn=lu_dir,layer="2012_wqlim_streams", integer64="warn.loss", verbose=FALSE)
# wqlim_lakes_shp <- readOGR(dsn=lu_dir,layer="2012_wqlim_lakes", integer64="warn.loss", verbose=FALSE)
# 
# wqlim1.df <- wqlim_streams_shp@data
# wqlim2.df <- wqlim_lakes_shp@data
# wqlim2.df <- wqlim2.df[,match(names(wqlim1.df), names(wqlim2.df))]
# 
# wqlim3.df <- rbind(wqlim1.df, wqlim2.df)

# wqlim4.df <- wqlim3.df %>% 
#   filter(OWRD_BAS == owrd_basin & STATUS_ID %in% c(3, 17 ,4, 14, 15)) %>%
#   dplyr::select(POLLUTANT, STATUS_ID) %>%
#   mutate(STATUS_ID=replace(STATUS_ID, STATUS_ID %in% c(3, 17), "cat5"),
#          STATUS_ID=replace(STATUS_ID, STATUS_ID %in% c(4, 14, 15), "catab")) %>%
#   count(POLLUTANT, STATUS_ID) %>%
#   group_by(POLLUTANT) %>%
#   spread(STATUS_ID, n, fill = 0)

#Code update to reflect wq limited streams and lakes approved by EPA in 2018. 4/24/19 EC
wqlim.df<-read.csv("C:/Basin_Reports_2018/lookup_tables/2012_wqlim_04222019.csv", header=TRUE)
owrdBasin_lu<-read.csv("C:/Basin_Reports_2018/lookup_tables/OWRD_Basins.csv", header=TRUE)

names(wqlim.df)[names(wqlim.df) == 'USGS.4th.Field.HUC'] <- 'HUC_8'

wqlim.df<-merge(x=wqlim.df, y=owrdBasin_lu, by="HUC_8", all.x=TRUE)

wqlim5.df <- wqlim.df %>% 
  filter(OWRD_BAS == owrd_basin & Status %in% c("Cat 4A: Water quality limited, TMDL approved", "Cat 4B: Water quality limited, other control measures" ,"Cat 5: Water quality limited, 303(d) list, TMDL needed")) %>%
  dplyr::select(Parameter, Status) %>%
  mutate(Status=replace(Status, Status %in% c("Cat 5: Water quality limited, 303(d) list, TMDL needed"), "cat5"),
         Status=replace(Status, Status %in% c("Cat 4A: Water quality limited, TMDL approved", "Cat 4B: Water quality limited, other control measures"), "catab")) %>%
  count(Parameter, Status) %>%
  group_by(Parameter) %>%
  spread(Status, n, fill = 0)

if(!("cat5" %in% colnames(wqlim5.df))) {wqlim5.df$cat5 <- 0}
if(!("catab" %in% colnames(wqlim5.df))) {wqlim5.df$catab <- 0}

wqlim5.df <- wqlim5.df[,c("Parameter","cat5","catab")]

names(wqlim5.df) <- c("Parameter", "Segments without a TMDL", "Segments with a TMDL") 

knitr::kable(wqlim5.df, format = "pandoc", padding = 2, caption = tbls(name="tbl.wql", caption="Number of impaired stream segments with and without a TMDL as identified in Oregon's 2012 Integrated Report and Assessment database."))

```


```{r TMDL-setup}

tmdls.df <- read_excel(path=paste0(lu_dir,"/Info_Integrated.xlsx"), sheet="TMDLs", na = c("","N/A", " "))
tmdls.df <- tmdls.df[tmdls.df$owrd_basin %in% owrd_basin,]

if(NROW(tmdls.df) > 0){
  
  # sort impairments by alphabetical order
  tmdls.df$impairments <- unlist(lapply(strsplit(tmdls.df$impairments, ","),  function(x) paste(sort(trimws(unlist(x))), collapse = ", ")))
  tmdls.df$weblink <- paste0("[",tmdls.df$TMDL,"](",tmdls.df$website,")")

  tmdls.df2 <- tmdls.df[,c("weblink","impairments")]
  colnames(tmdls.df2) <- c("TMDL Document Name", "Impairments Addressed")
  
  txt.tmdl <- paste0(tbls(name='tbl.tmdls', display='cite'), " lists the TMDLs that have been approved in the ",owrd_basin," Basin.")

} else {
  txt.tmdl <- paste0("\n\n* **Currently there are no TMDLs in the ",owrd_basin," Basin.**")
}

```
## Total Maximum Daily Load Watershed Plans

The federal Clean Water Act requires that water pollutant reduction plans, called Total Maximum Daily Loads (TMDLs), be developed for water bodies that are listed in Category 5 of the Integrated Report (303(d) List). TMDLs describe the maximum amount of pollutants that can enter the river or stream and still meet water quality standards.

TMDLs take into account the pollution from major sources including discharges from industry and sewage treatment facilities, runoff from farms, forests and urban areas, and natural sources. TMDLs include a margin of safety to account for uncertainty, and may include a reserve capacity that allows for future discharges to a river or stream. DEQ typically develops TMDLs on a watershed, subbasin, or basin level and occasionally at the reach level depending on the type and extent of impairments. 

The Water Quality Management Plan (WQMP) is the framework for TMDL implementation that is issued by Oregon along with the TMDL (Oregon Administrative Rules 340-042-0040(l)). The TMDL and WQMP serve as a multi-sector plan and provides the blueprint for TMDL related implementation activities. `r txt.tmdl`


```{r TMDL-table, results="asis"}

if(NROW(tmdls.df) > 0){
  print(knitr::kable(tmdls.df2, format = "pandoc", padding = 2, caption = tbls(name="tbl.tmdls", caption=paste0("Approved TMDLs in the ",owrd_basin," Basin and the impairments addressed by those TMDLs."))))
}

```


# Implementation Highlights

## Section 319 Grants

```{r 319-projects-setup}

program <- "319"

projects.df <- read_excel(path=paste0(lu_dir,"/Info_Integrated.xlsx"), sheet="2_Projects", na = c("","N/A", " "))

projects.n <- NROW(projects.df[projects.df$owrd_basin %in% owrd_basin & 
                                                projects.df$fund_program == program, c("budget")]$budget)
pix.df <- pix.df[NULL,]
pix.cap <- NULL

if(projects.n <= 0){
  
  txt.319 <-paste0("In 2018 there were no 319 projects with reported outputs in the ",owrd_basin,".")
  
  } else {
    
    projects.budget <- dollar(sum(as.numeric(projects.df[projects.df$owrd_basin %in% owrd_basin & 
                                                     projects.df$fund_program == program, c("budget")]$budget)))
    
    txt.319 <- paste0("In 2018, there ",was.were(projects.n)," ",
                      numbers.to.words(projects.n),
                      " 319 project",s(projects.n),
                      " active that reported project outputs and accomplishments to DEQ. Combined the projects have a total grant budget of ",
                      projects.budget, ". ", tbls('tbl.319_projects', display = 'cite'),
                      " describes the project",s(projects.n)," and the reported outputs.")
    
    deq319.df <- projects.df[projects.df$owrd_basin %in% owrd_basin & projects.df$fund_program == program, 
                             c("project_name","grantee", "objectives", "outputs")]
    
    colnames(deq319.df) <- c("Project Name", "Grantee", "Project Description", "Reported Outputs")
    
    # look for pictures
    pix.df <- projects.df[projects.df$owrd_basin %in% owrd_basin & projects.df$fund_program == program & 
                          projects.df$picture == "Yes", c("picture", "picture_caption","picture_file")]
    
    
    if(NROW(pix.df) > 0){
      pix.seed.df <- pix.df[sample(NROW(pix.df), size=1, replace = TRUE), c("picture_caption", "picture_file")]
      pix.cap <- figs(name="fig.319", caption=pix.seed.df$picture_caption)
      }
  }

```

Federal Section 319(h) funds are provided annually through the EPA to states for the development and implementation of each state's Nonpoint Source Management Program. In Oregon a portion of 319 grant funding is "passed through" to support community or partner projects that address Oregon's nonpoint source program priorities. Generally, DEQ requires grantees to report annually on the progress made implementing their grant project. This section highlights those outputs and accomplishments reported to DEQ in 2018. Note this section does not identify or include projects proposed and awarded a grant in 2018. Outputs and accomplishments for those projects will be reported to DEQ in future years once they have been implemented. For a listing of projects proposed and awarded a grant in 2018 see Section 3.6.2 of the main report.

`r txt.319`


```{r 319-tbl, results="asis"}

if(projects.n > 0) {
  print(knitr::kable(deq319.df, format = "pandoc", digits = 1, row.names=FALSE,
                     caption = tbls(name="tbl.319_projects", 
                                    caption="Project outputs reported in 2018 for Section 319 pass through grants.")))
}  



```


```{r 319-picture, fig.cap=pix.cap}

if(NROW(pix.df) > 0){
  knitr::include_graphics(path=paste0("pictures/",pix.seed.df$picture_file))
}

```


## Clean Water State Revolving Fund (CWSRF)


```{r CWSRF-projects-setup}

program <- "CWSRF"

projects.df <- read_excel(path=paste0(lu_dir,"/Info_Integrated.xlsx"), sheet="2_Projects", na = c("","N/A", " "))

projects.n <- NROW(projects.df[projects.df$owrd_basin %in% owrd_basin & 
                                                projects.df$fund_program == program, c("budget")]$budget)
pix.df <- pix.df[NULL,]
pix.cap <- NULL

if(projects.n <= 0){
  
  txt.CWSRF <-paste0("In 2018 there were no nonpoint source related Clean Water State Revolving Fund projects with reported outputs in the ",owrd_basin,".")

  } else {
    
    projects.budget <- dollar(sum(as.numeric(projects.df[projects.df$owrd_basin %in% owrd_basin & 
                                                     projects.df$fund_program == program, c("budget")]$budget)))
    
    txt.CWSRF <- paste0("In 2018 there ",was.were(projects.n)," ",
                      numbers.to.words(projects.n),
                      " nonpoint source related Clean Water State Revolving Fund project",s(projects.n),
                      " active that reported project outputs and accomplishments to DEQ. Combined the projects have a total budget of ",
                      projects.budget, ". ", tbls('tbl.CWSRF_projects', display = 'cite'),
                      " describes the project",s(projects.n)," and the reported outputs.")
    
    deqCWSRF.df <- projects.df[projects.df$owrd_basin %in% owrd_basin & projects.df$fund_program == program, 
                             c("project_name","grantee", "objectives", "outputs")]
    
    colnames(deqCWSRF.df) <- c("Project Name", "Grantee", "Project Description", "Reported Outputs")
    
    # look for pictures
    pix.df <- projects.df[projects.df$owrd_basin %in% owrd_basin & projects.df$fund_program == program & 
                          projects.df$picture == "Yes", c("picture", "picture_caption","picture_file")]
    
    if(NROW(pix.df) > 0){
      pix.seed.df <- pix.df[sample(NROW(pix.df), size=1, replace = TRUE), c("picture_caption", "picture_file")]
      pix.cap <- figs(name="fig.CWSRF", caption=pix.seed.df$picture_caption)
      }
  }

```


The Clean Water State Revolving Fund loan program provides below market rate loans to public agencies for the planning, design and construction of various projects that prevent or mitigate water pollution. Eligible agencies include federally recognized Indian tribal governments, cities, counties, sanitary districts, soil and water conservation districts, irrigation districts, various special districts and intergovernmental entities. DEQ partners with Oregon communities to implement projects that attain and maintain water quality standards, and are necessary to protect beneficial uses. This section highlights the ongoing projects and the outputs and accomplishments reported to DEQ in 2018.

`r txt.CWSRF`


```{r CWSRF-tbl, results="asis"}

if(projects.n > 0){
  print(knitr::kable(deqCWSRF.df, format = "pandoc", padding = 2, digits = 1, row.names=FALSE,  
               caption=tbls(name="tbl.CWSRF_projects", 
                            caption="Nonpoint source related Clean Water State Revolving Fund project outputs reported in 2018.")))
}

```


```{r CWSRF-picture, fig.cap=pix.cap}

if(nrow(pix.df) > 0){
  knitr::include_graphics(path=paste0("pictures/",pix.seed.df$picture_file))
}

```


## Source Water Protection Grants

```{r DWSRF-setup}

program <- "DWSRF"

projects.df <- read_excel(path=paste0(lu_dir,"/Info_Integrated.xlsx"), sheet="2_Projects", na = c("","N/A", " "))

projects.n <- NROW(projects.df[projects.df$owrd_basin %in% owrd_basin & 
                                                projects.df$fund_program == program, c("budget")]$budget)
pix.df <- pix.df[NULL,]
pix.cap <- NULL

if(projects.n <= 0){
  
  txt.DWSRF <-paste0("In 2018 there were no nonpoint source related Safe Drinking Water State Revolving Fund projects with reported outputs in the ",owrd_basin,".")

  } else {
    
    projects.budget <- dollar(sum(as.numeric(projects.df[projects.df$owrd_basin %in% owrd_basin & 
                                                     projects.df$fund_program == program, c("budget")]$budget)))
    
    txt.DWSRF <- paste0("In 2018 there ",was.were(projects.n)," ",
                      numbers.to.words(projects.n),
                      " nonpoint source related Safe Drinking Water State Revolving Fund project",s(projects.n),
                      " active that reported project outputs and accomplishments to DEQ. Combined the projects have a total budget of ",
                      projects.budget, ". ", tbls('tbl.DWSRF_projects', display = 'cite'),
                      " describes the project",s(projects.n)," and the reported outputs.")
    
    deqDWSRF.df <- projects.df[projects.df$owrd_basin %in% owrd_basin & projects.df$fund_program == program, 
                             c("project_name","grantee", "objectives", "outputs")]
    
    colnames(deqDWSRF.df) <- c("Project Name", "Grantee", "Project Description", "Reported Outputs")
    
    # look for pictures
    pix.df <- projects.df[projects.df$owrd_basin %in% owrd_basin & projects.df$fund_program == program & 
                          projects.df$picture == "Yes", c("picture", "picture_caption","picture_file")]
    
    if(NROW(pix.df) > 0){
      pix.seed.df <- pix.df[sample(NROW(pix.df), size=1, replace = TRUE), c("picture_caption", "picture_file")]
      pix.cap <- figs(name="fig.DWSRF", caption=pix.seed.df$picture_caption)
      }
  }

```


The Oregon Health Authority regulates drinking water under state law and the Safe Drinking Water Act and works cooperatively with DEQ on source water protection efforts. Using the Drinking Water Revolving Loan Fund, OHA funds Source Water Protection Grants (up to $30,000 per public water system) for source water protection activities, monitoring, and planning in Drinking Water Source Areas. In addition, loans are available for improving drinking water treatment, source water protection activities, or land acquisition in source areas. Oregon's Infrastructure Finance Authority is responsible for administering these projects. The loan fund set-asides also fund five Drinking Water Protection positions at DEQ that provide technical assistance to public water systems and communities while they develop and implement strategies that reduce the risk within the delineated source water areas. This section highlights the ongoing projects and the outputs and accomplishments reported to DEQ in 2018.

`r txt.DWSRF`


```{r DWSRF-tbl, results="asis"}

if(projects.n > 0){
  print(knitr::kable(deqDWSRF.df, format = "pandoc", padding = 2, digits = 1, row.names=FALSE, 
               caption = tbls(name="tbl.DWSRF_projects", 
                              caption="Nonpoint source Safe Drinking Water State Revolving Fund projects and outputs for 2018.")))
  }

```


```{r DWSRF-picture, fig.cap=pix.cap}

if(nrow(pix.df) > 0){
  knitr::include_graphics(path=paste0("pictures/",pix.seed.df$picture_file))
}

```


## Drinking Water Provider Partnership Grants

```{r DWPP-projects setup}

program <- "DWPP"

projects.df <- read_excel(path=paste0(lu_dir,"/Info_Integrated.xlsx"), sheet="2_Projects", na = c("","N/A", " "))

projects.n <- NROW(projects.df[projects.df$owrd_basin %in% owrd_basin & 
                                                projects.df$fund_program == program, c("budget")]$budget)
pix.df <- pix.df[NULL,]
pix.cap <- NULL

if(projects.n <= 0){
  
  txt.DWPP <-paste0("In 2018 there were no active Drinking Water Providers Partnership projects with reported outputs in the ",owrd_basin,".")

  } else {
    
    projects.budget <- dollar(sum(as.numeric(projects.df[projects.df$owrd_basin %in% owrd_basin & 
                                                     projects.df$fund_program == program, c("budget")]$budget)))
    
    txt.DWPP <- paste0("In 2018 there ",was.were(projects.n)," ",
                      numbers.to.words(projects.n),
                      " Drinking Water Providers Partnership project",s(projects.n),
                      " active that reported project outputs and accomplishments to te DWPP. Combined the projects have a total budget of ",
                      projects.budget, ". ", tbls('tbl.DWPP_projects', display = 'cite'),
                      " describes the project",s(projects.n)," and the reported outputs.")
    
    deqDWPP.df <- projects.df[projects.df$owrd_basin %in% owrd_basin & projects.df$fund_program == program, 
                             c("project_name","grantee", "objectives", "outputs")]
    
    colnames(deqDWPP.df) <- c("Project Name", "Grantee", "Project Description", "Reported Outputs")
    
    # look for pictures
    pix.df <- projects.df[projects.df$owrd_basin %in% owrd_basin & projects.df$fund_program == program & 
                          projects.df$picture == "Yes", c("picture", "picture_caption","picture_file")]
    
    if(NROW(pix.df) > 0){
      pix.seed.df <- pix.df[sample(NROW(pix.df), size=1, replace = TRUE), c("picture_caption", "picture_file")]
      pix.cap <- figs(name="fig.DWPP", caption=pix.seed.df$picture_caption)
      }
  }

```


Oregon DEQ participates in the Drinking Water Providers Partnership (DWPP) with USDA Forest Service Region 6, EPA Region 10, the U.S. Bureau of Land Management OR/WA Office, the Washington Department of Health, Geos Institute and WildEarth Guardians. Together, these partners coordinate a competitive grant solicitation and award program for environmental conservation and restoration projects in municipal watersheds across the Northwest. The Drinking Water Providers Partnership made the first of the annual awards in 2016 and most projects have a focus on nonpoint sources of pollution. The goal of the Partnership and the funding is to develop and support local partnerships to restore and protect the health of watersheds which communities depend upon for drinking water while also benefiting aquatic and riparian ecosystems, including the native fish that inhabit them. This section highlights the ongoing projects and the outputs and accomplishments reported to the DWPP in 2018.

`r txt.DWPP`


```{r DWPP-tbl, results="asis"}

if(projects.n > 0){
  print(knitr::kable(deqDWPP.df, format = "pandoc", padding = 2, digits = 1, row.names=FALSE,
               caption=tbls(name="tbl.DWPP_projects", 
                            caption = "Drinking Water Providers Partnership projects and outputs for 2018")))
  }

```


```{r DWPP-picture, fig.cap=pix.cap}

if(nrow(pix.df) > 0){
  knitr::include_graphics(path=paste0("pictures/",pix.seed.df$picture_file))
}

```


## OWEB Grant Funded Projects

```{r OWRI-db-connection}

options(stringsAsFactors = FALSE)

# --- Read OWRI data from access database -----------------

db_connect_string <- paste0("Driver={Microsoft Access Driver (*.mdb, *.accdb)};","DBQ=", owri.db)

channel <- dbConnect(odbc::odbc(),.connection_string = db_connect_string)

# I'm keeping the dataframes the same name that OWEB uses
ActivityCost <- dbReadTable(channel, "ActivityCost")
ActivityLU <- dbReadTable(channel, "ActivityLU")
ActivityTypeLU <- dbReadTable(channel, "ActivityTypeLU")
ProjectInfo <- dbReadTable(channel, "ProjectInfo")
Treatment <- dbReadTable(channel, "Treatment")
TreatmentLU <- dbReadTable(channel, "TreatmentLU")
TreatmentMetric <- dbReadTable(channel, "TreatmentMetric")
TreatmentMetricLU <- dbReadTable(channel, "TreatmentMetricLU")
UnitLU <- dbReadTable(channel, "UnitLU")
RiparianVtrRcr <- dbReadTable(channel, "RiparianVtrRcr")
InstreamWaterRight <- dbReadTable(channel, "InstreamWaterRight")
dbDisconnect(channel)


```



```{r OWRI-treatment-summary}

# Rename some of the Treatment Metrics
TreatmentMetricLU2 <- data.frame(TreatmentMetricLUID=c(1:8),
                                 TreatmentMetric=c("Area treated",
                                                   "Number of treatments",
                                                   "Stream sides treated",
                                                   "Volume",
                                                   "Length of treatment",
                                                   "Percent urban area affected",
                                                   "Percent watershed area affected",
                                                   "Volumetric flow rate"))

# Select only some of the riparian treatment metrics
RiparianVtrRcr2 <- RiparianVtrRcr %>%
  dplyr::select(TreatmentID, mile=LengthMiles,acre=BestAcres,feet=WidthFeet) %>%
  tidyr::gather(-TreatmentID, key="Unit",value="Quantity") %>%
  mutate(UnitLUID=case_when(Unit == "mile" ~ 10,
                            Unit == "acre" ~ 1,
                            Unit == "feet" ~ 8))

df.treatments <- Treatment %>%
  dplyr::select(PROJNUM ,ActivityTypeLUID, ActivityLUID, TreatmentLUID, TreatmentID) %>%
  dplyr::left_join(ActivityTypeLU[,c("ActivityTypeLUID", "ActivityType")], by="ActivityTypeLUID") %>%
  dplyr::left_join(ActivityLU[,c("ActivityLUID", "Activity")], by="ActivityLUID") %>%
  dplyr::left_join(TreatmentLU[,c("TreatmentLUID", "Treatment")], by="TreatmentLUID") %>%
  dplyr::left_join(TreatmentMetric, by="TreatmentID") %>%
  dplyr::left_join(TreatmentMetricLU2, by="TreatmentMetricLUID") %>%
  dplyr::left_join(UnitLU, by="UnitLUID") %>%
  dplyr::left_join(ProjectInfo, by="PROJNUM") %>%
  dplyr::filter(CompleteYear %in% my.year & SubbasinActual %in% huc8.name)

#-- Esturary ----

tbl.estuary <- df.treatments %>%
  dplyr::filter(ActivityType =="Estuary" & Unit == "acre") %>%
  dplyr::mutate(Activity_Unit=paste0(Activity," (",str_to_title(Unit),"s)")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit, Sum) %>%
  dplyr::rename(Subbasin=SubbasinActual)

eval.estuary <- ifelse(NROW(tbl.estuary) > 0, TRUE, FALSE)

#-- Fish Pasage ----

tbl.fish1 <- df.treatments %>%
  dplyr::filter(ActivityType =="Fish Passage" & TreatmentMetricLUID==2) %>%
  dplyr::mutate(Activity_Unit=paste0(ActivityType," ",Activity," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)

tbl.fish.final <- df.treatments %>%
  dplyr::filter(ActivityType =="Fish Screening" & TreatmentMetricLUID==2) %>%
  dplyr::mutate(Activity_Unit=paste0(Treatment," (",TreatmentMetric,")")) %>% 
  #tidyr::unite(col="Activity_Unit", c("Activity", "Treatment", "Unit"), sep = ", ", remove=FALSE) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum) %>%
  dplyr::full_join(tbl.fish1, by="SubbasinActual") %>%
  dplyr::rename(Subbasin=SubbasinActual)

eval.fish <- ifelse(NROW(tbl.fish.final) > 0, TRUE, FALSE)

#-- Instream ----


tbl.instream1 <- df.treatments %>%
  dplyr::filter(ActivityType =="Instream"
                & Unit =="mile"
                & Activity %in% c("Bank stabilization")) %>%
  dplyr::mutate(Activity_Unit="Stream bank stabilized (Miles)") %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)

tbl.instream2 <- df.treatments %>%
  dplyr::filter(ActivityType =="Instream"
                & Activity %in% c("Animal species removal",
                                  "Beaver introduction/encouragement")) %>%
  dplyr::mutate(Activity_Unit=paste0(Treatment," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)


tbl.instream3 <- df.treatments %>%
  dplyr::filter(ActivityType =="Instream"
                & !(Unit %in% c("main channel", "structure"))
                & Activity %in% c("Channel alteration")) %>%
  dplyr::mutate(TreatmentMetric=if_else(TreatmentMetric=="Length of treatment", "Feet", TreatmentMetric)) %>%
  dplyr::mutate(Activity_Unit=paste0(Treatment," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)

tbl.instream4 <- df.treatments %>%
  dplyr::filter(ActivityType =="Instream"
                & Activity %in% c("Engineered structures")) %>%
  dplyr::mutate(Activity_Unit="Engineered structures installed (Number of treatments)") %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)

tbl.instream5 <- df.treatments %>%
  dplyr::filter(ActivityType =="Instream"
                & ActivityLUID %in% c(8:13)) %>%
  dplyr::mutate(Activity=gsub(" *\\(.*?\\) *", "", Activity)) %>%
  dplyr::mutate(Activity_Unit=paste0(Activity," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)

tbl.instream6 <- df.treatments %>%
  dplyr::filter(ActivityType =="Instream"
                & Activity %in% c("Off-channel habitat")
                & TreatmentMetricLUID %in% c(2)) %>%
  dplyr::mutate(Activity_Unit=paste0("Off-channel habitat created, protected, or reconnected (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)

tbl.instream7 <- df.treatments %>%
  dplyr::filter(ActivityType =="Instream"
                & Activity %in% c("Other instream activity")
                & TreatmentLUID %in% c(76)) %>%
  dplyr::mutate(Activity_Unit=paste0(Treatment," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)

tbl.instream8 <- df.treatments %>%
  dplyr::filter(ActivityType =="Instream"
                & Activity %in% c("Salmon carcass placement")
                & Unit %in% c("pound", "mile")) %>%
  dplyr::mutate(Unit=if_else(Unit=="mile", "Linear stream miles of treatment", "Pounds")) %>%
  dplyr::mutate(Activity_Unit=paste0(Activity," (",Unit,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)


tbl.instream.final1 <- tbl.instream1 %>%
  dplyr::full_join(tbl.instream3, by="SubbasinActual") %>%
  dplyr::rename(Subbasin=SubbasinActual)

tbl.instream.final2 <- tbl.instream2 %>%
  dplyr::full_join(tbl.instream7, by="SubbasinActual") %>%
  dplyr::full_join(tbl.instream8, by="SubbasinActual") %>%
  dplyr::rename(Subbasin=SubbasinActual)

tbl.instream.final3 <- tbl.instream4 %>%
  dplyr::full_join(tbl.instream5, by="SubbasinActual") %>%
  dplyr::full_join(tbl.instream6, by="SubbasinActual") %>%
  dplyr::rename(Subbasin=SubbasinActual)

eval.instream1 <- ifelse(NROW(tbl.instream.final1) > 0, TRUE, FALSE)
eval.instream2 <- ifelse(NROW(tbl.instream.final2) > 0, TRUE, FALSE)
eval.instream3 <- ifelse(NROW(tbl.instream.final3) > 0, TRUE, FALSE)

#-- Instream Flow ----

tbl.flow <- df.treatments %>%
  dplyr::filter(ActivityType =="Instream Flow"
                & !(is.na(Unit))) %>%
  dplyr::mutate(Activity_Unit=paste0(Treatment, " (",Unit,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum)

eval.flow <- ifelse(NROW(tbl.flow) > 0, TRUE, FALSE)

#-- Riparian Planting and Tree Retention -----

# Voluntary Riparian Tree Retention
tbl.rip1<- df.treatments %>%
  dplyr::select(-Unit,-UnitLUID,-Quantity) %>%
  dplyr::left_join(RiparianVtrRcr2, by="TreatmentID") %>%
  dplyr::filter(ActivityType =="Riparian" & 
                  Activity %in% c("Voluntary riparian tree retention") & 
                  Unit %in% c("mile", "acre")) %>%
  dplyr::mutate(Activity_Unit=paste0(Activity," (",str_to_title(Unit),"s)")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit, Sum)
  

# Riparian
tbl.rip.final <- df.treatments %>%
  dplyr::filter(ActivityType =="Riparian" & 
                  Activity %in% c("Riparian tree planting", "Riparian fencing") & 
                  Unit %in% c("mile", "acre")) %>%
  dplyr::mutate(Activity_Unit=paste0(Activity," (",str_to_title(Unit),"s)")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum) %>%
  dplyr::full_join(tbl.rip1, by="SubbasinActual") %>%
  dplyr::rename(Subbasin=SubbasinActual)

eval.rip <- ifelse(NROW(tbl.rip.final) > 0, TRUE, FALSE)

# -- Road ----
# check with OWEB on 'station' units?? Not being used here.

tbl.road <- df.treatments %>%
  dplyr::filter(ActivityType =="Road"
                & TreatmentMetricLUID %in% c(2)) %>% 
  dplyr::mutate(Activity_Unit=paste0(Activity," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum) %>%
  dplyr::rename(Subbasin=SubbasinActual)

eval.road <- ifelse(NROW(tbl.road) > 0, TRUE, FALSE)

# -- Upland ----

tbl.upland1 <- df.treatments %>%
  dplyr::filter(ActivityType =="Upland"
                & Activity %in% c("Agriculture management",
                                  "Conservation buffers",
                                  "Conservation tillage",
                                  "Irrigation system improvement")
                & TreatmentMetricLUID %in% c(1, 2)) %>%
  dplyr::mutate(TreatmentMetric=if_else(Unit=="acre", "acres treated", TreatmentMetric)) %>%
  dplyr::mutate(Activity_Unit=paste0(Activity," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum) %>%
  dplyr::rename(Subbasin=SubbasinActual)

tbl.upland2 <- df.treatments %>%
  dplyr::filter(ActivityType =="Upland"
                & Activity %in% c("Grazing management",
                                  "Nutrient/manure management",
                                  "Off-channel livestock or wildlife watering",
                                  "Upland fencing")
                & TreatmentMetricLUID %in% c(1, 2)) %>%
  dplyr::mutate(TreatmentMetric=if_else(Unit=="acre", "acres treated", TreatmentMetric)) %>%
  dplyr::mutate(Activity_Unit=paste0(Activity," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum) %>%
  dplyr::rename(Subbasin=SubbasinActual)


tbl.upland3 <- df.treatments %>%
  dplyr::filter(ActivityType =="Upland"
                & Activity %in% c("Other upland activity",
                                  "Terracing",
                                  "Upland erosion control",
                                  "Water/sediment control basins")
                & TreatmentMetricLUID %in% c(1, 2)) %>%
  dplyr::mutate(TreatmentMetric=if_else(Unit=="acre", "acres treated", TreatmentMetric)) %>%
  dplyr::mutate(Activity_Unit=paste0(Activity," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum) %>%
  dplyr::rename(Subbasin=SubbasinActual)

tbl.upland4 <- df.treatments %>%
  dplyr::filter(ActivityType =="Upland"
                & Activity %in% c("Upland invasive plant control",
                                  "Upland tree planting",
                                  "Upland vegetation management",
                                  "Upland vegetation planting",
                                  "Voluntary upland tree retention")
                & TreatmentMetricLUID %in% c(1, 2)) %>%
  dplyr::mutate(TreatmentMetric=if_else(Unit=="acre", "acres treated", TreatmentMetric)) %>%
  dplyr::mutate(Activity_Unit=paste0(Activity," (",TreatmentMetric,")")) %>% 
  dplyr::group_by(SubbasinActual, Activity_Unit) %>%
  dplyr::summarise(Sum=sum(Quantity)) %>%
  tidyr::spread(Activity_Unit,Sum) %>%
  dplyr::rename(Subbasin=SubbasinActual)

eval.upland1 <- ifelse(NROW(tbl.upland1) > 0, TRUE, FALSE)
eval.upland2 <- ifelse(NROW(tbl.upland2) > 0, TRUE, FALSE)
eval.upland3 <- ifelse(NROW(tbl.upland3) > 0, TRUE, FALSE)
eval.upland4 <- ifelse(NROW(tbl.upland3) > 0, TRUE, FALSE)

```

```{r OWEB-setup}

projects.df <- get.OWRI.projects(owri.mdb=owri.db,huc8.names=huc8.name, complete.years=my.year)

projects.n <- NROW(projects.df)


if(projects.n <= 0){
  
  txt.OWEB <-paste0("In 2017 there were no OWEB funded projects compleated and reported on in the ",owrd_basin,".")

  } else {
    
    projects.budget <- dollar(sum(as.numeric(projects.df$Total)))
    
    projects.df <- projects.df[with(projects.df, order(SubbasinActual, ActivityTypes, ProjName)), c("SubbasinActual", "ProjName","ActivityTypes","drvdProjDesc","Participants", "Results")]
  
    colnames(projects.df) <- c("Subbasin","Project Name", "Project Type", "Project Description", "Participants", "Reported Outputs")
    
    txt.OWEB <- paste0("Based on the most recent data available in OWEB's Oregon Watershed Restoration Inventory (OWRI) database, there ",was.were(projects.n)," ",
                      numbers.to.words(projects.n),
                      " OWEB funded project",s(projects.n)," completed in 2017 with a total cash and inkind budget of ",
                      projects.budget, 
                      ". The tables below summarize reported outputs for different project activities in each ",
                      owrd_basin," subbasin. ")
    
}

```

The Oregon Watershed Enhancement Board (OWEB) is a state agency that provides grants to help Oregonians take care of local streams, rivers, wetlands, and natural areas. These grant projects often address nonpoint sources of pollution and are thus included in this report.

`r txt.OWEB`

Learn more about OWEB grant programs at https://www.oregon.gov/OWEB/grants/Pages/grant-programs.aspx.


```{r table-estuarine-by-subbasin, results="asis", eval=eval.estuary}

knitr::kable(tbl.estuary,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_estuarine_by_subbasin", 
                            caption ="Summary of OWEB grant funded estuarine projects completed in 2017, the most recent year data is available in the OWEB OWRI database."))

```

```{r table-fish-by-subbasin, results="asis", eval=eval.fish}

knitr::kable(tbl.fish.final,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_fish_by_subbasin", 
                            caption ="Summary of OWEB grant funded fish passage projects completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r table-instream1-by-subbasin, results="asis", eval=eval.instream1}

knitr::kable(tbl.instream.final1,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_instream1_by_subbasin", 
                            caption ="Summary of OWEB grant funded instream projects completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r table-instream2-by-subbasin, results="asis", eval=eval.instream2}

knitr::kable(tbl.instream.final2,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_instream2_by_subbasin", 
                            caption ="Summary of OWEB grant funded instream projects (continued) completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```


```{r table-instream3-by-subbasin, results="asis", eval=eval.instream3}

knitr::kable(tbl.instream.final3,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_instream3_by_subbasin", 
                            caption ="Summary of OWEB grant funded instream projects completed (continued) in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r table-flow-by-subbasin, results="asis", eval=eval.flow}

knitr::kable(tbl.flow,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_flow_by_subbasin", 
                            caption ="Summary of OWEB grant funded instream flow projects completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r table-riparian-by-subbasin, results="asis", eval=eval.rip}

knitr::kable(tbl.rip.final,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_riparian_by_subbasin", 
                            caption ="Summary of OWEB grant funded riparian projects completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r table-road-by-subbasin, results="asis", eval=eval.road}

knitr::kable(tbl.road,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_road_by_subbasin", 
                            caption ="Summary of OWEB grant funded road projects completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r table-upland1-by-subbasin, results="asis", eval=eval.upland1}

knitr::kable(tbl.upland1,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_upland_by_subbasin", 
                            caption ="Summary of OWEB grant funded upland projects completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r table-upland2-by-subbasin, results="asis", eval=eval.upland2}

knitr::kable(tbl.upland2,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_upland2_by_subbasin", 
                            caption ="Summary of OWEB grant funded upland projects (continued) completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r table-upland3-by-subbasin, results="asis", eval=eval.upland3}

knitr::kable(tbl.upland3,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_upland3_by_subbasin", 
                            caption ="Summary of OWEB grant funded upland projects (continued) completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r table-upland4-by-subbasin, results="asis", eval=eval.upland4}

knitr::kable(tbl.upland4,
             padding = 2, digits = 1, row.names = FALSE, 
             caption = tbls(name = "table_upland4_by_subbasin", 
                            caption ="Summary of OWEB grant funded upland projects (continued) completed in 2017, the most recent year data is available in the OWEB OWRI database."))


```

```{r dma-projects-setup, results="asis"}

pix.df <- pix.df[NULL,]
pix.cap <- NULL

projects.df <- read_excel(path=paste0(lu_dir,"/Info_Integrated.xlsx"), sheet="5_TMDL_Implementation", na = c("","N/A", " "))
tmdl.imp.df <-projects.df[projects.df$owrd_basin %in% owrd_basin, c("TMDL", "DMA", "actions")]

colnames(tmdl.imp.df) <- c("TMDL", "DMA", "Reported Actions")
```

`r if(nrow(tmdl.imp.df) > 0){"## TMDL Implementation Highlights\n\n

TMDL implementation actions taken by Designated Management Agencies (DMAs) or third parties are described in the table below. Most of these actions were summarized from annual reports submitted by DMAs to DEQ in calendar year 2018.\n\n"}`


```{r dma-projects, results="asis"}

if(nrow(tmdl.imp.df) > 0){
  
  print(knitr::kable(tmdl.imp.df, format = "pandoc", padding = 2, digits = 1, row.names=FALSE, 
                     caption = tbls(name="tbl.dma_projects", 
                                    caption="TMDL implementation activities reported in 2018 by Designated Management Agencies or third parties.")))
  
  # pix.df <- projects.df[projects.df$owrd_basin %in% owrd_basin & 
  #                         projects.df$picture == "Yes", c("picture", "picture_caption","picture_file")]
  # 
  # if(nrow(pix.df) > 0){
  #   pix.seed.df <- pix.df[sample(nrow(pix.df), size=1, replace = TRUE), c("picture_caption", "picture_file")]
  #   pix.cap <- figs(name="TMDL_imp.fig",caption=pix.seed.df$picture_caption)
  # }
}

```


```{r dma-picture, fig.cap=pix.cap}

if(nrow(pix.df) > 0){
  knitr::include_graphics(path=paste0("pictures/",pix.seed.df$picture_file))
}

```






